---
title: "P8105 Homework 3"
author: "Riyadh Baksh"
date: "`r Sys.Date()`"
output: github_document
---

# Problem 1

The data contained in `ny_noaa` provides information about the weather in New York on various dates. There are a total of 7 variables (columns) and 2,595,176 observations (rows). For each date, there are 5 metrics, including precipitation, snow, snow depth, maximum temperature, and minimum temperature. There is also an id variable. At a glance, there is a lot of missing data, across many variables.

```{r, message=FALSE}
library(tidyverse)
library(p8105.datasets)

data("ny_noaa")

ny_noaa
```

The dates are separated into 3 columns representing the year, month, and date. The units are changed to more commonly used values. Precipitation is converted to mm, instead of tenths of mm. Temperature is reported in Celsius, instead of tenths of Celsius. Snow depth is reported in inches, instead of mm. These were all done because of normal conventions. Snowfall is reported in tenths of inches because often it is a small amount of snow that falls per period of time.

```{r}

ny_noaa =
  mutate(ny_noaa,
         year = year(date),
         month = month(date),
         day = day(date),
         prcp = as.numeric(prcp)/10, # convert to mm from tenths of mm
         tmax = as.numeric(tmax)/10, # convert to C from tenths of C
         tmin = as.numeric(tmin)/10, # convert to C from tenths of C
         snow = as.numeric(snow)/25.4*10, # convert to tenths of inches from mm
         snwd = as.numeric(snwd)/25.4 # convert to inches from mm
         )

```

The average snowfall is `r round(mean(ny_noaa$snow,na.rm=TRUE),2)` tenths of an inch. This makes sense since for much of the year, there is no snowfall, so it brings down the average.

The plots below show the average max temperature in January and July, across all stations, for each year. There is a lot of scatter, but roughly in January the average max temperature increased and then plateaued, whereas for July, it stayed about the same. That being said, there are a lot of points that don't follow this pattern. Due to this large scatter, it's difficult to say whether there are outliers, since there isn't a clear pattern.

```{r, message=FALSE}

library(patchwork)

january =
  ny_noaa |>
  drop_na(tmax) |>
  filter(month==1) |>
  group_by(year) |>
  summarize(mean_tmax = mean(tmax, na.rm=TRUE)) |>
  ggplot(aes(x=year,y=mean_tmax)) +
    geom_point() +
    geom_smooth(se=FALSE) +
    labs(
      title = "January Temperature",
      x = "Year",
      y = "Average Maximum Temperature (C)"
    )

july =
  ny_noaa |>
  drop_na(tmax) |>
  filter(month==7) |>
  group_by(year) |>
  summarize(mean_tmax = mean(tmax, na.rm=TRUE)) |>
  ggplot(aes(x=year,y=mean_tmax)) +
    geom_point() +
    geom_smooth(se=FALSE) +
    labs(
      title = "July Temperature",
      x = "Year",
      y = "Average Maximum Temperature (C)"
    )

(january + july)

```

```{r, message=FALSE}

tmax_tmin =
  ny_noaa |>
  drop_na(tmax, tmin) |>
  ggplot(aes(x=tmax,y=tmin)) +
    geom_point(alpha = 0.5) +
    geom_smooth(se=FALSE) +
    labs(
      title = "Temperature Plot",
      x = "Minimum Temperature (C)",
      y = "Maximum Temperature (C)"
    )

snowfall =
  ny_noaa |>
  select(year,snow) |>
  drop_na(snow) |>
  filter(snow>0, snow<100) |>
  ggplot(aes(x=year,y=snow)) +
    geom_boxplot(aes(group=year)) +
    labs(
      title = "Snowfall Distribution",
      x = "Year",
      y = "Snowfall (Tenths of Inch)"
    )

(tmax_tmin + snowfall)

```

# Problem 2

The demographic dataset is loaded and tidied below.

```{r}
demo = 
  read_csv(file = "data/nhanes_covar.csv", skip=4) |>
  janitor::clean_names() |>
  mutate(
    sex = case_match(
      sex,
      1 ~ "male",
      2 ~ "female"
    ),
    education = case_match(
      education,
      1 ~ "less than high school",
      2 ~ "high school equivalent",
      3 ~ "more than high school"
    ),
    sex = as.factor(sex),
    education = as.factor(education),
    age = as.integer(age)
  )

demo
```

The accelerometer data is loaded and tided below.

```{r}
accel = 
  read_csv(file = "data/nhanes_accel.csv") |>
  janitor::clean_names()
```

Next, the two datasets are combined and further tidying is done. This now prepares the final dataset in `mims`.

```{r}
mims =
  left_join(demo,accel,by="seqn") |>
  drop_na(sex:education) |>
  filter(age>=21) |>
  pivot_longer(
    min1:last_col(),
    names_to = "minute",
    names_prefix = "min",
    values_to = "mims"
  )

mims
```

The table below shows the number of men and women in each education category. There are more males in high school equivalent, whereas about the same male and female in the other educations. There are overall more people in "more than high school" than "high school equivalent" than "less than high school".

```{r}
demo |>
  drop_na() |>
  janitor::tabyl(education, sex)
```

The grouped boxplot below shows the age distribution for male and female at each education level. There is a lot of spread, but the median age is lowest for those with "more than high school" education. Males have a median age younger than females for all educations, except "more than high school".

```{r}
demo |>
  select(education,sex,age) |>
  drop_na() |>
  ggplot(aes(x=education,y=age,fill=sex)) +
    geom_boxplot() +
    labs(
      title = "Age Distribution",
      x = "Education Level",
      y = "Age"
    )
```

The plots below show the sum of the MIMS for each individual, across ages, between male and female, and for each education level. In general, as you get older, the total MIMS decreases. For "less than high school", males typically have higher MIMS (except at young ages), whereas for the other education levels, females typically have higher MIMS.

```{r, message=FALSE}
less =
  mims |>
  filter(education=="less than high school") |>
  aggregate(mims ~ seqn, sum) |>
  left_join(demo,by="seqn") |>
  ggplot(aes(x=age,y=mims)) +
    geom_point(aes(color=sex)) +
    geom_smooth(aes(color=sex),se=FALSE) +
    labs(title="Less than high school")

more =
  mims |>
  filter(education=="more than high school") |>
  aggregate(mims ~ seqn, sum) |>
  left_join(demo,by="seqn") |>
  ggplot(aes(x=age,y=mims)) +
    geom_point(aes(color=sex)) +
    geom_smooth(aes(color=sex),se=FALSE) +
    labs(title="More than high school")

equiv =
  mims |>
  filter(education=="high school equivalent") |>
  aggregate(mims ~ seqn, sum) |>
  left_join(demo,by="seqn") |>
  ggplot(aes(x=age,y=mims)) +
    geom_point(aes(color=sex)) +
    geom_smooth(aes(color=sex),se=FALSE) +
    labs(title="High school equivalent")

(less+equiv)/more

```

The plots below show the MIMS value at each hour for both male and female, for different education levels, but across all ages. In general, females have higher MIMS throughout the day. Across all educations, MIMS decreases than increases to a peak in the middle, then decreases again. This could reflect the decreasing movement as people are falling asleep, then the greater movement that peaks in the middle of the day, then the decreasing movement towards the night.

```{r, message=FALSE}
less =
  mims |>
  filter(education=="less than high school") |>
  ggplot(aes(x=as.numeric(minute)/60,y=mims)) +
    geom_smooth(aes(color=sex),se=FALSE) +
    labs(
      title="Less than high school",
      x="hour")

more =
  mims |>
  filter(education=="more than high school") |>
  ggplot(aes(x=as.numeric(minute)/60,y=mims)) +
    geom_smooth(aes(color=sex),se=FALSE) +
    labs(
      title="More than high school",
      x="hour")

equiv =
  mims |>
  filter(education=="high school equivalent") |>
  ggplot(aes(x=as.numeric(minute)/60,y=mims)) +
    geom_smooth(aes(color=sex),se=FALSE) +
    labs(
      title="High school equivalent",
      x="hour")

(less+equiv)/more

```

# Problem 3

